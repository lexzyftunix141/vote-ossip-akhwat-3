<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin OSSIP - Log Aktivitas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        /* ===== NOTIFICATION SYSTEM ===== */
        .notification-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }

        .notification {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease;
            border-left: 4px solid #4CAF50;
            max-width: 350px;
        }

        .notification.info {
            border-left-color: #2196F3;
        }

        .notification.warning {
            border-left-color: #FF9800;
        }

        .notification.error {
            border-left-color: #F44336;
        }

        .notification.success {
            border-left-color: #4CAF50;
        }

        .notification-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .notification-info {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #333;
            font-size: 14px;
        }

        .notification-message {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        .notification-close {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 14px;
            padding: 4px;
            flex-shrink: 0;
        }

        .notification-close:hover {
            color: #666;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        /* ===== NEW ACTIVITY INDICATOR ===== */
        .new-activity-indicator {
            position: fixed;
            top: 70px;
            right: 20px;
            background: #FF5722;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            cursor: pointer;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* ===== AUTO-REFRESH STATUS ===== */
        .auto-refresh-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(33, 150, 243, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 9997;
            backdrop-filter: blur(10px);
        }

        .auto-refresh-status i {
            animation: spin 10s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* ===== DASHBOARD CONTAINER ===== */
        .admin-dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* ===== SIDEBAR ===== */
        .admin-sidebar {
            width: 280px;
            background: #1a237e;
            color: white;
            padding: 25px 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 5px 0 15px rgba(0,0,0,0.2);
            z-index: 100;
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255,255,255,0.1);
        }

        .admin-profile {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .profile-avatar {
           width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            border: 3px solid rgba(255, 255, 255, 0.2);
        }

        .admin-profile h3 {
            margin: 10px 0 5px;
            font-size: 18px;
            font-weight: 600;
        }

        .admin-role {
            color: #a0a0ff;
            font-size: 13px;
            margin: 0 0 5px;
        }

        .admin-username {
            color: #888;
            font-size: 12px;
            font-style: italic;
            margin: 0;
        }

        /* Navigation Menu */
        .admin-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .admin-menu li {
            margin-bottom: 5px;
        }

        .admin-menu a {
            display: flex;
            align-items: center;
            color: #b0b0b0;
            text-decoration: none;
            padding: 15px 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 15px;
        }

        .admin-menu a:hover {
            background: rgba(102, 126, 234, 0.2);
            color: white;
            transform: translateX(5px);
        }

        .admin-menu a.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .admin-menu a i {
            margin-right: 12px;
            font-size: 16px;
            width: 24px;
            text-align: center;
        }

        .logout-section {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        /* ===== MAIN CONTENT ===== */
        .admin-main-content {
            flex: 1;
            background: #f5f7fb;
            overflow-y: auto;
            padding: 20px;
        }

        /* ===== PAGE HEADER ===== */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .page-header h1 {
            font-size: 24px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .ossip-badge {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        /* ===== BUTTON STYLES ===== */
        .btn-primary, .btn-secondary, .btn-filter {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f1f3f9;
            color: #555;
            border: 1px solid #ddd;
        }

        .btn-secondary:hover {
            background: #e4e7f0;
            transform: translateY(-2px);
        }

        .btn-filter {
            background: #2196F3;
            color: white;
            border: none;
        }

        .btn-filter:hover {
            background: #1976D2;
            transform: translateY(-2px);
        }

        /* ===== OSSIP BANNER ===== */
        .ossip-log-banner {
            background: linear-gradient(135deg, #1a237e, #283593);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
            text-align: center;
            font-size: 16px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        /* ===== LOG STATISTICS ===== */
        .log-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .stat-card .icon {
            font-size: 32px;
            margin-bottom: 15px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
            color: #2c3e50;
        }

        .stat-card .label {
            color: #666;
            font-size: 14px;
        }

        /* ===== FILTER SECTION ===== */
        .logs-filter-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .log-search-box {
            position: relative;
        }

        .log-search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }

        .log-search-box input {
            padding-left: 45px;
        }

        .date-range {
            display: flex;
            gap: 15px;
        }

        /* ===== LOGS TABLE ===== */
        .voters-table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .logs-table {
            width: 100%;
            border-collapse: collapse;
        }

        .logs-table thead {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }

        .logs-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
            border-bottom: 2px solid #dee2e6;
        }

        .logs-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            vertical-align: middle;
        }

        .logs-table tbody tr:hover {
            background-color: #f8f9fa;
        }

        /* ===== LOG LEVEL BADGES ===== */
        .log-level {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .level-info {
            background: #e3f2fd;
            color: #1976d2;
        }

        .level-success {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .level-warning {
            background: #fff3e0;
            color: #f57c00;
        }

        .level-error {
            background: #ffebee;
            color: #c62828;
        }

        .level-security {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        /* ===== LOG USER ===== */
        .log-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
        }

        .log-details {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        /* ===== LOG ACTIONS ===== */
        .log-actions {
            display: flex;
            gap: 8px;
        }

        .log-actions button {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .log-actions button:hover {
            background: #f0f2f5;
            color: #2196f3;
        }

        /* ===== LOG IP ===== */
        .log-ip {
            font-family: 'Courier New', monospace;
            background: #f8f9fa;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #495057;
        }

        /* ===== PAGINATION ===== */
        .pagination {
            display: flex;
            justify-content: center;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }

        .pagination ul {
            display: flex;
            list-style: none;
            gap: 5px;
        }

        .pagination li {
            margin: 0;
        }

        .page-link {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border: 1px solid #ddd;
            border-radius: 8px;
            color: #495057;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .page-link:hover {
            background: #f8f9fa;
            border-color: #2196f3;
        }

        .page-item.active .page-link {
            background: #2196f3;
            color: white;
            border-color: #2196f3;
        }

        .page-item.disabled .page-link {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ===== FOOTER ===== */
        .admin-footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
            margin-top: 20px;
        }

        .admin-footer p {
            margin: 5px 0;
        }

        /* ===== MODAL ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #2c3e50;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            line-height: 1;
        }

        .close-modal:hover {
            color: #333;
        }

        .modal-body {
            padding: 30px;
        }

        /* ===== LOG DETAIL CONTENT ===== */
        .log-detail-content {
            display: grid;
            gap: 20px;
        }

        .detail-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
        }

        .detail-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .detail-value {
            color: #333;
            font-size: 14px;
            line-height: 1.6;
            word-break: break-word;
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            color: #ddd;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #495057;
        }

        .empty-state p {
            color: #6c757d;
        }

        /* ===== LAST UPDATE INFO ===== */
        .last-update-info {
            text-align: center;
            color: #666;
            font-size: 13px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* ===== LOADING STATES ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-content {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }

        .loading-content i {
            font-size: 48px;
            color: #2196F3;
            margin-bottom: 20px;
            display: block;
        }

        .loading-content p {
            font-size: 16px;
            color: #333;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .btn-retry {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 20px;
            font-weight: 500;
        }

        .btn-retry:hover {
            background: #2980b9;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1200px) {
            .admin-dashboard-container {
                flex-direction: column;
            }
            
            .admin-sidebar {
                width: 100%;
                padding: 15px;
            }
            
            .admin-profile {
                display: flex;
                align-items: center;
                gap: 15px;
                text-align: left;
            }
            
            .profile-avatar {
                width: 50px;
                height: 50px;
                font-size: 24px;
                margin: 0;
            }
            
            .admin-menu ul {
                display: flex;
                gap: 10px;
                overflow-x: auto;
                padding: 10px 0;
            }
            
            .admin-menu li {
                margin: 0;
            }
            
            .admin-menu a {
                padding: 10px 15px;
                white-space: nowrap;
            }
            
            .logout-section {
                position: absolute;
                top: 15px;
                right: 15px;
                margin: 0;
                padding: 0;
                border: none;
            }
            
            .logout-section button {
                width: auto;
                padding: 8px 15px;
            }
        }

        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .header-actions {
                width: 100%;
                justify-content: center;
            }
            
            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            .date-range {
                flex-direction: column;
            }
            
            .logs-table {
                min-width: 800px;
            }
            
            .log-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .log-stats {
                grid-template-columns: 1fr;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-card .value {
                font-size: 24px;
            }
            
            .btn-primary, .btn-secondary, .btn-filter {
                padding: 10px 15px;
                font-size: 13px;
            }
            
            .modal-content {
                width: 95%;
                margin: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- New Activity Indicator -->
    <div class="new-activity-indicator" id="newActivityIndicator" style="display: none;" onclick="loadNewLogs()">
        <i class="fas fa-bell"></i>
        <span id="newLogsCount">0</span> log baru
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Auto Refresh Status -->
    <div class="auto-refresh-status" id="autoRefreshStatus">
        <i class="fas fa-sync-alt"></i>
        Auto-refresh: <span id="refreshTimer">10s</span>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <i class="fas fa-spinner fa-spin"></i>
            <p id="loadingText">Memuat log aktivitas...</p>
            <button class="btn-retry" onclick="retryLoad()" style="display: none;">
                <i class="fas fa-redo"></i> Coba Lagi
            </button>
        </div>
    </div>

    <div class="admin-dashboard-container">
        <!-- Sidebar -->
        <div class="admin-sidebar">
            <div class="admin-profile">
                <div class="profile-avatar">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div>
                    <h3 id="adminName">Memuat...</h3>
                    <p class="admin-role" id="adminRole">Memuat...</p>
                    <p class="admin-username" id="adminUsername">@memuat</p>
                </div>
            </div>
            
            <nav class="admin-menu">
                <ul>
                    <li>
                        <a href="admin-dashboard.html">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li>
                        <a href="admin-voters.html">
                            <i class="fas fa-users"></i>
                            <span>Data Santri</span>
                        </a>
                    </li>
                    <li>
                        <a href="admin-statistics.html">
                            <i class="fas fa-chart-bar"></i>
                            <span>Statistik</span>
                        </a>
                    </li>
                    <li class="active">
                        <a href="admin-logs.html">
                            <i class="fas fa-history"></i>
                            <span>Log Aktivitas</span>
                        </a>
                    </li>
                    <li>
                        <a href="admin-settings.html">
                            <i class="fas fa-cog"></i>
                            <span>Pengaturan</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="logout-section">
                <button class="btn-primary" onclick="showLogoutConfirm()" style="width: 100%;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="admin-main-content">
            <!-- Page Header -->
            <div class="page-header">
                <h1><i class="fas fa-history"></i> Log Aktivitas Sistem OSSIP <span class="ossip-badge">Real-time</span></h1>
                <div class="header-actions">
                    <button class="btn-secondary" onclick="clearOldLogs()">
                        <i class="fas fa-trash"></i> Hapus Log Lama
                    </button>
                    <button class="btn-primary" onclick="exportLogs()">
                        <i class="fas fa-download"></i> Ekspor Log
                    </button>
                </div>
            </div>

            <!-- OSSIP Banner -->
            <div class="ossip-log-banner">
                <i class="fas fa-mosque"></i> LOG SISTEM PEMILIHAN PENGURUS OSSIP 2024-2025
                <div style="font-size: 12px; margin-top: 5px;">
                    <i class="fas fa-broadcast-tower"></i> Monitoring real-time â€¢ Auto-refresh setiap 10 detik
                </div>
            </div>

            <!-- Log Statistics -->
            <div class="log-stats" id="logStats">
                <div class="stat-card">
                    <div class="icon" style="color: #1a237e;">
                        <i class="fas fa-spinner fa-spin"></i>
                    </div>
                    <div class="value">-</div>
                    <div class="label">Memuat statistik...</div>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="logs-filter-section">
                <div class="filter-grid">
                    <div class="form-group log-search-box">
                        <label for="logSearch"><i class="fas fa-search"></i> Cari Log</label>
                        <i class="fas fa-search"></i>
                        <input type="text" id="logSearch" class="form-control" placeholder="Pesan, pengguna, atau IP..." oninput="filterLogs()">
                    </div>
                    <div class="form-group">
                        <label for="logLevel"><i class="fas fa-filter"></i> Level Log</label>
                        <select id="logLevel" class="form-control" onchange="filterLogs()">
                            <option value="">Semua Level</option>
                            <option value="info">Info</option>
                            <option value="warning">Warning</option>
                            <option value="error">Error</option>
                            <option value="success">Success</option>
                            <option value="security">Security</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="logUser"><i class="fas fa-user"></i> Pengguna</label>
                        <select id="logUser" class="form-control" onchange="filterLogs()">
                            <option value="">Semua Pengguna</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="logModule"><i class="fas fa-cube"></i> Modul</label>
                        <select id="logModule" class="form-control" onchange="filterLogs()">
                            <option value="">Semua Modul</option>
                            <option value="auth">Autentikasi</option>
                            <option value="voting">Pemilihan</option>
                            <option value="candidate">Calon Pengurus</option>
                            <option value="system">Sistem</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </div>
                <div class="filter-grid" style="margin-top: 20px;">
                    <div class="form-group date-range">
                        <div style="flex: 1;">
                            <label for="startDate">Dari Tanggal</label>
                            <input type="date" id="startDate" class="form-control" onchange="filterLogs()">
                        </div>
                        <div style="flex: 1;">
                            <label for="endDate">Sampai Tanggal</label>
                            <input type="date" id="endDate" class="form-control" onchange="filterLogs()">
                        </div>
                    </div>
                    <div style="display: flex; align-items: flex-end; gap: 10px;">
                        <button class="btn-filter" onclick="filterLogs()">
                            <i class="fas fa-filter"></i> Terapkan Filter
                        </button>
                        <button class="btn-secondary" onclick="resetFilters()">
                            <i class="fas fa-redo"></i> Reset
                        </button>
                    </div>
                </div>
            </div>

            <!-- Last Update Info -->
            <div class="last-update-info">
                <i class="fas fa-clock"></i> Terakhir diperbarui: <span id="lastUpdateTime">-</span>
                â€¢ Auto-refresh: <span id="nextRefreshTime">-</span>
            </div>

            <!-- Logs Table -->
            <div class="voters-table-container">
                <div class="table-responsive">
                    <table class="logs-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Level</th>
                                <th>Pengguna</th>
                                <th>Pesan</th>
                                <th>Modul</th>
                                <th>IP Address</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            <tr>
                                <td colspan="7">
                                    <div class="empty-state">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        <h3>Memuat log aktivitas...</h3>
                                        <p>Mohon tunggu sebentar</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Pagination -->
            <div class="pagination">
                <ul class="pagination" id="logsPagination"></ul>
            </div>

            <!-- Footer -->
            <div class="admin-footer">
                <p>&copy; 2024 Organisasi Siswa Santri (OSSIP). Hak Cipta Dilindungi.</p>
                <p><i class="fas fa-mosque"></i> Pondok Pesantren Tahfidz Insan Pratama 2</p>
                <p>Log disimpan selama 90 hari | Sistem real-time aktif</p>
            </div>
        </div>
    </div>

    <!-- Modal Detail Log -->
    <div id="logDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-info-circle"></i> Detail Log OSSIP</h3>
                <button class="close-modal" onclick="closeLogDetailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="log-detail-content" id="logDetailContent"></div>
                <div class="modal-actions" style="margin-top: 20px; text-align: right;">
                    <button type="button" class="btn-secondary" onclick="closeLogDetailModal()">Tutup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div id="logoutModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-sign-out-alt"></i> Konfirmasi Logout</h3>
                <button class="close-modal" onclick="closeLogoutModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Apakah Anda yakin ingin logout dari sistem admin?</p>
            </div>
            <div class="modal-actions" style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn-secondary" onclick="closeLogoutModal()">Batal</button>
                <button type="button" class="btn-primary" onclick="doLogout()">Ya, Logout</button>
            </div>
        </div>
    </div>

    <!-- Load Database Script -->
    <script src="database.js"></script>
    
    <script>
        // ===== GLOBAL VARIABLES =====
        let allLogs = [];
        let filteredLogs = [];
        let currentPage = 1;
        const logsPerPage = 20;
        let autoRefreshInterval;
        let lastLogCount = 0;
        let newLogsCount = 0;
        let refreshTimer = 10;
        let refreshInterval;
        let isAutoRefreshEnabled = true;
        let lastUpdateTime = null;
        let isInitialized = false;

        // ===== UTILITY FUNCTIONS =====
        
        // Show notification
        function showNotification(title, message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            // Set icon based on type
            let icon = 'fas fa-info-circle';
            switch(type) {
                case 'success': icon = 'fas fa-check-circle'; break;
                case 'warning': icon = 'fas fa-exclamation-triangle'; break;
                case 'error': icon = 'fas fa-times-circle'; break;
                case 'info': icon = 'fas fa-info-circle'; break;
            }
            
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="${icon}"></i>
                </div>
                <div class="notification-info">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // Add to container
            container.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }
            }, 5000);
        }

        // Show loading
        function showLoading(show = true, message = 'Memuat...') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            const retryBtn = overlay.querySelector('.btn-retry');
            
            if (show) {
                overlay.style.display = 'flex';
                loadingText.textContent = message;
                retryBtn.style.display = 'none';
            } else {
                overlay.style.display = 'none';
            }
        }

        // Show retry button
        function showRetryButton() {
            const retryBtn = document.querySelector('.btn-retry');
            if (retryBtn) {
                retryBtn.style.display = 'inline-block';
            }
        }

        // ===== DATABASE FUNCTIONS =====
        
        // Wait for database
        async function waitForDatabase() {
            console.log('ðŸ”„ Waiting for database...');
            
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 30; // 15 detik
                
                const checkDatabase = () => {
                    attempts++;
                    
                    if (window.db && typeof window.db.getAllAuditLogs === 'function') {
                        console.log('âœ… Database ready!');
                        resolve();
                        return;
                    }
                    
                    if (attempts >= maxAttempts) {
                        reject(new Error(`Database tidak ditemukan setelah ${maxAttempts} detik`));
                        return;
                    }
                    
                    setTimeout(checkDatabase, 500);
                };
                
                checkDatabase();
            });
        }

        // Check session
        function checkSession() {
            console.log('ðŸ” Checking session...');
            
            const isLoggedIn = sessionStorage.getItem('adminLoggedIn');
            const adminUsername = sessionStorage.getItem('adminUsername');
            
            if (!isLoggedIn || !adminUsername) {
                console.log('âŒ Not logged in - redirecting');
                alert('âš ï¸ Anda harus login sebagai admin terlebih dahulu!');
                window.location.href = 'admin-login.html';
                return false;
            }
            
            // Set admin info
            const adminName = sessionStorage.getItem('adminName') || 'Admin';
            const adminRole = sessionStorage.getItem('adminRole') || 'Administrator';
            
            document.getElementById('adminName').textContent = adminName;
            document.getElementById('adminRole').textContent = adminRole;
            document.getElementById('adminUsername').textContent = '@' + adminUsername;
            
            console.log('âœ… Session valid');
            return true;
        }

        // Load logs from database
        async function loadLogsData() {
            console.log('ðŸ“Š Loading logs data...');
            showLoading(true, 'Memuat log aktivitas...');
            
            try {
                // Wait for database
                await waitForDatabase();
                
                if (!window.db || typeof window.db.getAllAuditLogs !== 'function') {
                    throw new Error('Database atau fungsi getAllAuditLogs tidak tersedia');
                }
                
                // Get logs from database
                const logs = await window.db.getAllAuditLogs();
                console.log('ðŸ“ˆ Logs received:', logs.length);
                
                if (!logs) {
                    throw new Error('Tidak ada data log yang diterima');
                }
                
                return logs;
                
            } catch (error) {
                console.error('âŒ Error loading logs:', error);
                throw error;
            } finally {
                showLoading(false);
            }
        }

        // Update log statistics
        function updateLogStats(logs) {
            const totalLogs = logs.length;
            
            // Categorize logs
            const infoLogs = logs.filter(log => 
                !log.action.includes('ERROR') && 
                !log.action.includes('WARNING') &&
                !log.action.includes('SUCCESS') &&
                !log.action.includes('VOTE_CAST') &&
                !log.action.includes('LOGIN') &&
                !log.action.includes('SECURITY')
            ).length;
            
            const warningLogs = logs.filter(log => log.action.includes('WARNING')).length;
            const errorLogs = logs.filter(log => log.action.includes('ERROR')).length;
            const successLogs = logs.filter(log => 
                log.action.includes('SUCCESS') || 
                log.action.includes('VOTE_CAST')
            ).length;
            
            const securityLogs = logs.filter(log => 
                log.action.includes('LOGIN') || 
                log.action.includes('LOGOUT') ||
                log.action.includes('SECURITY')
            ).length;
            
            // Get today's logs
            const today = new Date().toDateString();
            const todayLogs = logs.filter(log => 
                new Date(log.timestamp).toDateString() === today
            ).length;
            
            // Update stats display
            document.getElementById('logStats').innerHTML = `
                <div class="stat-card">
                    <div class="icon" style="color: #1a237e;">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="value">${totalLogs.toLocaleString()}</div>
                    <div class="label">Total Log</div>
                </div>
                <div class="stat-card">
                    <div class="icon" style="color: #4CAF50;">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                    <div class="value">${todayLogs.toLocaleString()}</div>
                    <div class="label">Hari Ini</div>
                </div>
                <div class="stat-card">
                    <div class="icon" style="color: #2196F3;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="value">${successLogs.toLocaleString()}</div>
                    <div class="label">Berhasil</div>
                </div>
                <div class="stat-card">
                    <div class="icon" style="color: #FF9800;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="value">${warningLogs.toLocaleString()}</div>
                    <div class="label">Peringatan</div>
                </div>
                <div class="stat-card">
                    <div class="icon" style="color: #F44336;">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="value">${errorLogs.toLocaleString()}</div>
                    <div class="label">Error</div>
                </div>
            `;
        }

        // Update user filter options
        function updateUserFilterOptions(logs) {
            const userSelect = document.getElementById('logUser');
            const currentValue = userSelect.value;
            
            // Get unique users from logs
            const users = [...new Set(logs.map(log => log.user_name).filter(name => name))].sort();
            
            // Update options
            userSelect.innerHTML = '<option value="">Semua Pengguna</option>';
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                userSelect.appendChild(option);
            });
            
            // Restore previous selection if still valid
            if (currentValue && users.includes(currentValue)) {
                userSelect.value = currentValue;
            }
        }

        // ===== LOGS MANAGEMENT =====
        
        // Refresh logs
        async function refreshLogs() {
            try {
                // Update last update time
                lastUpdateTime = new Date();
                document.getElementById('lastUpdateTime').textContent = 
                    lastUpdateTime.toLocaleTimeString('id-ID', { 
                        hour: '2-digit', 
                        minute: '2-digit',
                        second: '2-digit'
                    });
                
                // Load logs
                const logs = await loadLogsData();
                
                // Store previous count for comparison
                const previousCount = allLogs.length;
                
                // Sort logs by timestamp (newest first)
                logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                allLogs = logs;
                
                // Update filters and stats
                updateUserFilterOptions(logs);
                updateLogStats(logs);
                
                // Apply current filters
                filterLogs();
                
                // Reset refresh timer
                refreshTimer = 10;
                updateRefreshTimer();
                
                // Check for new logs
                if (previousCount > 0 && logs.length > previousCount) {
                    const newCount = logs.length - previousCount;
                    newLogsCount += newCount;
                    
                    // Update indicator
                    const indicator = document.getElementById('newActivityIndicator');
                    const countElement = document.getElementById('newLogsCount');
                    
                    countElement.textContent = newLogsCount;
                    indicator.style.display = 'flex';
                    
                    showNotification(
                        'Log Baru',
                        `Ada ${newCount} log aktivitas baru`,
                        'info'
                    );
                }
                
                showNotification('Data Diperbarui', 'Log aktivitas berhasil dimuat', 'success');
                
            } catch (error) {
                console.error('âŒ Error refreshing logs:', error);
                showNotification('Error', 'Gagal memuat log: ' + error.message, 'error');
                
                // Show error in table
                document.getElementById('logsTableBody').innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <i class="fas fa-exclamation-triangle"></i>
                                <h3>Gagal memuat log</h3>
                                <p>${error.message}</p>
                                <button class="btn-retry" onclick="retryLoad()" style="margin-top: 15px;">
                                    <i class="fas fa-redo"></i> Coba Lagi
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }
        }

        // Filter logs based on criteria
        function filterLogs() {
            const searchTerm = document.getElementById('logSearch').value.toLowerCase();
            const levelFilter = document.getElementById('logLevel').value;
            const userFilter = document.getElementById('logUser').value;
            const moduleFilter = document.getElementById('logModule').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            filteredLogs = allLogs.filter(log => {
                // Search term filter
                if (searchTerm) {
                    const searchableText = [
                        log.action || '',
                        log.details || '',
                        log.user_name || '',
                        log.ip_address || ''
                    ].join(' ').toLowerCase();
                    
                    if (!searchableText.includes(searchTerm)) {
                        return false;
                    }
                }
                
                // Level filter
                if (levelFilter) {
                    let logLevel = 'info';
                    
                    if (log.action.includes('ERROR')) logLevel = 'error';
                    else if (log.action.includes('WARNING')) logLevel = 'warning';
                    else if (log.action.includes('SUCCESS') || log.action.includes('VOTE_CAST')) logLevel = 'success';
                    else if (log.action.includes('LOGIN') || log.action.includes('SECURITY')) logLevel = 'security';
                    
                    if (logLevel !== levelFilter) {
                        return false;
                    }
                }
                
                // User filter
                if (userFilter && log.user_name !== userFilter) {
                    return false;
                }
                
                // Module filter
                if (moduleFilter) {
                    let logModule = 'system';
                    
                    if (log.action.includes('LOGIN') || log.action.includes('AUTH')) logModule = 'auth';
                    else if (log.action.includes('VOTE')) logModule = 'voting';
                    else if (log.action.includes('CANDIDATE')) logModule = 'candidate';
                    else if (log.action.includes('ADMIN')) logModule = 'admin';
                    
                    if (logModule !== moduleFilter) {
                        return false;
                    }
                }
                
                // Date filter
                if (startDate) {
                    const logDate = new Date(log.timestamp).toISOString().slice(0, 10);
                    if (logDate < startDate) {
                        return false;
                    }
                }
                
                if (endDate) {
                    const logDate = new Date(log.timestamp).toISOString().slice(0, 10);
                    if (logDate > endDate) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // Reset to first page
            currentPage = 1;
            
            // Render filtered logs
            renderLogsTable();
            renderPagination();
        }

        // Reset all filters
        function resetFilters() {
            document.getElementById('logSearch').value = '';
            document.getElementById('logLevel').value = '';
            document.getElementById('logUser').value = '';
            document.getElementById('logModule').value = '';
            
            // Reset dates to default (last week to today)
            const today = new Date();
            const lastWeek = new Date(today);
            lastWeek.setDate(lastWeek.getDate() - 7);
            
            document.getElementById('startDate').value = lastWeek.toISOString().slice(0, 10);
            document.getElementById('endDate').value = today.toISOString().slice(0, 10);
            
            filterLogs();
            
            showNotification('Filter Direset', 'Semua filter telah direset', 'info');
        }

        // ===== RENDERING FUNCTIONS =====
        
        // Render logs table
        function renderLogsTable() {
            const tableBody = document.getElementById('logsTableBody');
            
            if (filteredLogs.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <i class="fas fa-clipboard-list"></i>
                                <h3>Tidak ada log yang ditemukan</h3>
                                <p>Coba ubah filter pencarian Anda</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Calculate pagination
            const startIndex = (currentPage - 1) * logsPerPage;
            const endIndex = startIndex + logsPerPage;
            const pageLogs = filteredLogs.slice(startIndex, endIndex);
            
            let tableHTML = '';
            
            pageLogs.forEach(log => {
                const date = new Date(log.timestamp);
                const timeString = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                const dateString = date.toLocaleDateString('id-ID');
                
                // Determine log level
                let level = 'info';
                let levelClass = 'level-info';
                
                if (log.action.includes('ERROR')) {
                    level = 'error';
                    levelClass = 'level-error';
                } else if (log.action.includes('WARNING')) {
                    level = 'warning';
                    levelClass = 'level-warning';
                } else if (log.action.includes('SUCCESS') || log.action.includes('VOTE_CAST')) {
                    level = 'success';
                    levelClass = 'level-success';
                } else if (log.action.includes('LOGIN') || log.action.includes('SECURITY')) {
                    level = 'security';
                    levelClass = 'level-security';
                }
                
                // Determine module
                let module = 'system';
                if (log.action.includes('LOGIN') || log.action.includes('AUTH')) module = 'auth';
                else if (log.action.includes('VOTE')) module = 'voting';
                else if (log.action.includes('CANDIDATE')) module = 'candidate';
                else if (log.action.includes('ADMIN')) module = 'admin';
                
                // Truncate long messages
                let message = log.details || log.action;
                if (message.length > 100) {
                    message = message.substring(0, 100) + '...';
                }
                
                // Highlight new logs (added in the last 5 minutes)
                const isNew = (Date.now() - new Date(log.timestamp).getTime()) < 5 * 60 * 1000;
                
                tableHTML += `
                    <tr${isNew ? ' style="background-color: #f0f9ff;"' : ''}>
                        <td>
                            <div><strong>${dateString}</strong></div>
                            <div class="log-details">${timeString} ${isNew ? 'ðŸ†•' : ''}</div>
                        </td>
                        <td><span class="log-level ${levelClass}">${level}</span></td>
                        <td>
                            <div class="log-user">
                                <div class="user-avatar">
                                    ${log.user_name ? log.user_name.charAt(0).toUpperCase() : 'S'}
                                </div>
                                <div>
                                    <div><strong>${log.user_name || 'System'}</strong></div>
                                    <div class="log-details">${log.user_id || 'system'}</div>
                                </div>
                            </div>
                        </td>
                        <td class="log-message" title="${log.details || log.action}">${message}</td>
                        <td><span class="log-level level-info">${module}</span></td>
                        <td><span class="log-ip">${log.ip_address || 'localhost'}</span></td>
                        <td>
                            <div class="log-actions">
                                <button onclick="viewLogDetail('${log.id}')" title="Lihat Detail">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="copyLog('${log.id}')" title="Salin Log">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
        }

        // Render pagination
        function renderPagination() {
            const totalPages = Math.ceil(filteredLogs.length / logsPerPage);
            const pagination = document.getElementById('logsPagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;
            
            // Page numbers
            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
            
            // Adjust start page if we're near the end
            if (endPage - startPage + 1 < maxPagesToShow) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <li class="page-item ${currentPage === i ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                    </li>
                `;
            }
            
            // Next button
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;
            
            pagination.innerHTML = paginationHTML;
        }

        // Change page
        function changePage(page) {
            const totalPages = Math.ceil(filteredLogs.length / logsPerPage);
            
            if (page < 1 || page > totalPages) return;
            
            currentPage = page;
            renderLogsTable();
            renderPagination();
        }

        // ===== LOG DETAIL FUNCTIONS =====
        
        // View log detail
        async function viewLogDetail(logId) {
            try {
                // Find the log
                const log = allLogs.find(l => l.id === logId);
                
                if (!log) {
                    showNotification('Log tidak ditemukan', 'ID log tidak valid', 'error');
                    return;
                }
                
                const detailContent = document.getElementById('logDetailContent');
                const date = new Date(log.timestamp);
                
                // Determine log level
                let level = 'info';
                let levelClass = 'level-info';
                
                if (log.action.includes('ERROR')) {
                    level = 'error';
                    levelClass = 'level-error';
                } else if (log.action.includes('WARNING')) {
                    level = 'warning';
                    levelClass = 'level-warning';
                } else if (log.action.includes('SUCCESS') || log.action.includes('VOTE_CAST')) {
                    level = 'success';
                    levelClass = 'level-success';
                } else if (log.action.includes('LOGIN') || log.action.includes('SECURITY')) {
                    level = 'security';
                    levelClass = 'level-security';
                }
                
                detailContent.innerHTML = `
                    <div class="detail-item">
                        <div class="detail-label">Timestamp</div>
                        <div class="detail-value">${date.toLocaleString('id-ID')}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Action</div>
                        <div class="detail-value">${log.action}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Level</div>
                        <div class="detail-value">
                            <span class="log-level ${levelClass}">${level.toUpperCase()}</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Pengguna</div>
                        <div class="detail-value">${log.user_name || 'System'} (${log.user_id || 'system'})</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Detail</div>
                        <div class="detail-value">${log.details || 'Tidak ada detail tambahan'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">IP Address</div>
                        <div class="detail-value">${log.ip_address || 'localhost'}</div>
                    </div>
                `;
                
                document.getElementById('logDetailModal').style.display = 'flex';
                
            } catch (error) {
                console.error('âŒ Error viewing log detail:', error);
                showNotification('Error', 'Gagal memuat detail log', 'error');
            }
        }

        // Close log detail modal
        function closeLogDetailModal() {
            document.getElementById('logDetailModal').style.display = 'none';
        }

        // Copy log to clipboard
        async function copyLog(logId) {
            try {
                const log = allLogs.find(l => l.id === logId);
                
                if (!log) {
                    showNotification('Error', 'Log tidak ditemukan', 'error');
                    return;
                }
                
                const logText = `[${new Date(log.timestamp).toLocaleString()}] [${log.action}] ${log.user_name || 'System'}: ${log.details || ''}`;
                
                await navigator.clipboard.writeText(logText);
                
                showNotification('Berhasil', 'Log berhasil disalin ke clipboard', 'success');
                
            } catch (error) {
                console.error('âŒ Error copying log:', error);
                showNotification('Error', 'Gagal menyalin log', 'error');
            }
        }

        // ===== LOG ACTIONS =====
        
        // Clear old logs
        async function clearOldLogs() {
            if (!confirm('Apakah Anda yakin ingin menghapus log yang berusia lebih dari 30 hari?\n\nAksi ini tidak dapat dibatalkan.')) {
                return;
            }
            
            showLoading(true, 'Menghapus log lama...');
            
            try {
                // Calculate date 30 days ago
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                // Filter logs older than 30 days
                const logsToDelete = allLogs.filter(log => 
                    new Date(log.timestamp) < thirtyDaysAgo
                );
                
                // For now, we'll just remove them from the display
                // In a real app, you would call a delete function on the database
                console.log(`Akan menghapus ${logsToDelete.length} log lama`);
                
                // Add audit log for this action
                if (window.db && window.db.addAuditLog) {
                    await window.db.addAuditLog({
                        action: 'LOGS_CLEARED',
                        user_id: sessionStorage.getItem('adminUsername') || 'admin',
                        user_name: sessionStorage.getItem('adminName') || 'Admin',
                        details: `Menghapus ${logsToDelete.length} log yang berusia lebih dari 30 hari`,
                        ip_address: 'localhost'
                    });
                }
                
                // Refresh logs to show updated list
                await refreshLogs();
                
                showNotification('Berhasil', `${logsToDelete.length} log lama berhasil dihapus`, 'success');
                
            } catch (error) {
                console.error('âŒ Error clearing old logs:', error);
                showNotification('Error', 'Gagal menghapus log lama: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Export logs
        async function exportLogs() {
            try {
                const format = prompt('Pilih format ekspor log OSSIP:\n1. CSV (Excel)\n2. JSON\n3. Text', '1');
                
                if (!format) return;
                
                showLoading(true, 'Menyiapkan ekspor...');
                
                let exportData;
                let filename;
                let mimeType;
                
                switch(format) {
                    case '1': // CSV
                        exportData = convertLogsToCSV(filteredLogs);
                        filename = `ossip_logs_${new Date().toISOString().slice(0, 10)}.csv`;
                        mimeType = 'text/csv';
                        break;
                        
                    case '2': // JSON
                        exportData = JSON.stringify(filteredLogs, null, 2);
                        filename = `ossip_logs_${new Date().toISOString().slice(0, 10)}.json`;
                        mimeType = 'application/json';
                        break;
                        
                    case '3': // Text
                        exportData = convertLogsToText(filteredLogs);
                        filename = `ossip_logs_${new Date().toISOString().slice(0, 10)}.txt`;
                        mimeType = 'text/plain';
                        break;
                        
                    default:
                        showNotification('Error', 'Format tidak valid', 'error');
                        return;
                }
                
                // Create download link
                const blob = new Blob([exportData], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // Add audit log
                if (window.db && window.db.addAuditLog) {
                    await window.db.addAuditLog({
                        action: 'LOGS_EXPORTED',
                        user_id: sessionStorage.getItem('adminUsername') || 'admin',
                        user_name: sessionStorage.getItem('adminName') || 'Admin',
                        details: `Mengekspor ${filteredLogs.length} log dalam format ${format === '1' ? 'CSV' : format === '2' ? 'JSON' : 'Text'}`,
                        ip_address: 'localhost'
                    });
                }
                
                showNotification('Berhasil', `Log berhasil diekspor (${filename})`, 'success');
                
            } catch (error) {
                console.error('âŒ Error exporting logs:', error);
                showNotification('Error', 'Gagal mengekspor log: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Convert logs to CSV
        function convertLogsToCSV(logs) {
            const headers = ['Timestamp', 'Action', 'Level', 'User ID', 'User Name', 'Details', 'IP Address'];
            const rows = logs.map(log => {
                // Determine level
                let level = 'info';
                if (log.action.includes('ERROR')) level = 'error';
                else if (log.action.includes('WARNING')) level = 'warning';
                else if (log.action.includes('SUCCESS') || log.action.includes('VOTE_CAST')) level = 'success';
                else if (log.action.includes('LOGIN') || log.action.includes('SECURITY')) level = 'security';
                
                return [
                    new Date(log.timestamp).toISOString(),
                    log.action,
                    level,
                    log.user_id || 'system',
                    log.user_name || 'System',
                    `"${(log.details || '').replace(/"/g, '""')}"`,
                    log.ip_address || 'localhost'
                ];
            });
            
            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        // Convert logs to text
        function convertLogsToText(logs) {
            return logs.map(log => {
                const date = new Date(log.timestamp);
                return `[${date.toLocaleString('id-ID')}] [${log.action}] ${log.user_name || 'System'}: ${log.details || ''}`;
            }).join('\n');
        }

        // ===== AUTO-REFRESH FUNCTIONS =====
        
        // Setup auto-refresh
        function setupAutoRefresh() {
            console.log('ðŸ”— Setting up auto-refresh...');
            
            // Clear existing interval
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            // Auto-refresh every 10 seconds
            autoRefreshInterval = setInterval(async () => {
                if (!document.hidden && isAutoRefreshEnabled) {
                    try {
                        await checkForNewLogs();
                    } catch (error) {
                        console.log('Auto-refresh error:', error);
                    }
                }
            }, 10000); // 10 detik
        }

        // Start refresh timer
        function startRefreshTimer() {
            refreshTimer = 10;
            updateRefreshTimer();
            
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            refreshInterval = setInterval(() => {
                refreshTimer--;
                updateRefreshTimer();
                
                if (refreshTimer <= 0) {
                    refreshTimer = 10;
                    if (isAutoRefreshEnabled) {
                        checkForNewLogs();
                    }
                }
            }, 1000);
        }

        // Update refresh timer display
        function updateRefreshTimer() {
            document.getElementById('refreshTimer').textContent = refreshTimer + 's';
            
            // Update next refresh time
            const nextRefresh = new Date(Date.now() + refreshTimer * 1000);
            document.getElementById('nextRefreshTime').textContent = 
                'dalam ' + refreshTimer + ' detik (' + nextRefresh.toLocaleTimeString('id-ID', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    second: '2-digit'
                }) + ')';
        }

        // Check for new logs
        async function checkForNewLogs() {
            try {
                if (!window.db || !window.db.getAllAuditLogs) return;
                
                const currentLogs = await window.db.getAllAuditLogs();
                
                if (allLogs.length > 0) {
                    // Find new logs
                    const newLogs = currentLogs.filter(newLog => 
                        !allLogs.some(existingLog => existingLog.id === newLog.id)
                    );
                    
                    if (newLogs.length > 0) {
                        // Update count
                        newLogsCount += newLogs.length;
                        
                        // Show indicator
                        const indicator = document.getElementById('newActivityIndicator');
                        const countElement = document.getElementById('newLogsCount');
                        
                        countElement.textContent = newLogsCount;
                        indicator.style.display = 'flex';
                        
                        // Show notification for new logs
                        showNotification(
                            'Log Baru',
                            `Ada ${newLogs.length} log aktivitas baru`,
                            'info'
                        );
                    }
                }
                
            } catch (error) {
                console.error('Error checking for new logs:', error);
            }
        }

        // Load new logs when indicator is clicked
        async function loadNewLogs() {
            const indicator = document.getElementById('newActivityIndicator');
            indicator.style.display = 'none';
            newLogsCount = 0;
            
            showNotification('Memuat...', 'Mengambil log terbaru', 'info');
            await refreshLogs();
        }

        // ===== LOGOUT FUNCTIONS =====
        
        // Show logout confirmation
        function showLogoutConfirm() {
            document.getElementById('logoutModal').style.display = 'flex';
        }

        // Close logout modal
        function closeLogoutModal() {
            document.getElementById('logoutModal').style.display = 'none';
        }

        // Perform logout
        function doLogout() {
            // Add logout audit log
            if (window.db && window.db.addAuditLog) {
                window.db.addAuditLog({
                    action: 'ADMIN_LOGOUT',
                    user_id: sessionStorage.getItem('adminUsername') || 'admin',
                    user_name: sessionStorage.getItem('adminName') || 'Admin',
                    details: 'Admin logout dari sistem logs',
                    ip_address: 'localhost'
                });
            }
            
            // Clear session
            sessionStorage.clear();
            
            // Redirect to login
            window.location.href = 'admin-login.html';
        }

        // ===== INITIALIZATION =====
        
        // Initialize page
        async function initializePage() {
            console.log('ðŸš€ Initializing logs page...');
            
            try {
                // Check session
                if (!checkSession()) return;
                
                // Set default dates
                const today = new Date();
                const lastWeek = new Date(today);
                lastWeek.setDate(lastWeek.getDate() - 7);
                
                document.getElementById('startDate').value = lastWeek.toISOString().slice(0, 10);
                document.getElementById('endDate').value = today.toISOString().slice(0, 10);
                
                // Wait for database
                await waitForDatabase();
                
                // Load initial logs
                await refreshLogs();
                
                // Setup auto-refresh
                setupAutoRefresh();
                
                // Start refresh timer
                startRefreshTimer();
                
                // Setup event listeners
                setupEventListeners();
                
                isInitialized = true;
                
                console.log('âœ… Logs page initialized successfully');
                
            } catch (error) {
                console.error('âŒ Initialization failed:', error);
                showNotification('Error', 'Gagal menginisialisasi halaman: ' + error.message, 'error');
                showRetryButton();
            }
        }

        // Retry load
        function retryLoad() {
            console.log('ðŸ”„ Retrying load...');
            initializePage();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Close modals when clicking outside
            window.addEventListener('click', function(event) {
                const logDetailModal = document.getElementById('logDetailModal');
                const logoutModal = document.getElementById('logoutModal');
                
                if (event.target === logDetailModal) {
                    closeLogDetailModal();
                }
                if (event.target === logoutModal) {
                    closeLogoutModal();
                }
            });
            
            // Escape key to close modals
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeLogDetailModal();
                    closeLogoutModal();
                }
            });
        }

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });

        // ===== START APPLICATION =====
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸ“„ DOM Content Loaded');
            
            // Start initialization with a small delay
            setTimeout(() => {
                initializePage();
            }, 100);
        });

        // Global error handlers
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
        });

        console.log('=== LOGS SCRIPT LOADED ===');
    </script>
</body>
</html>